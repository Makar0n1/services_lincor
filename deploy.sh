#!/bin/bash

# LinkChecker Production Deployment Script
# Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ´Ğ¾Ğ¼ĞµĞ½Ğ° lincor.repsdeltsgear.store

echo "ğŸš€ Starting LinkChecker deployment..."

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Docker
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker is not installed. Please install Docker first."
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "âŒ Docker Compose is not installed. Please install Docker Compose first."
    exit 1
fi

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ .env Ñ„Ğ°Ğ¹Ğ»Ğ° ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ Ğ½ĞµÑ‚
if [ ! -f .env ]; then
    echo "ğŸ“ Creating .env file from template..."
    cp env.production .env
    echo "âš ï¸  Please edit .env file with your production values before continuing!"
    echo "   Especially: JWT_SECRET, SMTP credentials, Google Service Account"
    read -p "Press Enter after editing .env file..."
fi

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸ Ğ´Ğ»Ñ SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ²
mkdir -p nginx/ssl

# ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²
echo "ğŸ›‘ Stopping existing containers..."
docker-compose down

# Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²
echo "ğŸ”¨ Building Docker images..."
docker-compose build --no-cache

# Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
echo "ğŸš€ Starting services..."
docker-compose up -d

# ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
echo "â³ Waiting for services to start..."
sleep 30

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
echo "ğŸ“Š Checking service status..."
docker-compose ps

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° health check
echo "ğŸ¥ Checking health status..."
curl -f http://localhost:3000/health || echo "âŒ Health check failed"

echo "âœ… Deployment completed!"
echo "ğŸŒ API Gateway: http://localhost:3000"
echo "ğŸ” Health Check: http://localhost:3000/health"
echo "ğŸ“Š Monitor logs: docker-compose logs -f"
echo "ğŸ›‘ Stop services: docker-compose down"
